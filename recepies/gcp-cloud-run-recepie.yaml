# cloudrun-recipe.yaml
name: gcp-cloud-run
description: Deploy to Google Cloud Run
provider: gcp
service: cloud-run

required_fields:
  - name: project
    description: GCP project ID
    type: string
    default: my-gcp-project

  - name: region
    description: GCP region to deploy to
    type: string
    default: us-central1

  - name: name
    description: Service name (used for Cloud Run service and container naming)
    type: string

  - name: registry_name
    description: Docker registry prefix (e.g., gcr.io/my-project, us-docker.pkg.dev/my-project/repo)
    type: string

  - name: template
    description: Dockerfile template name (path relative to _templates directory)
    type: string

optional_fields:
  - name: cloud_run.min_instances
    description: Minimum instances (0 for scale to zero)
    type: int
    default: "0"

  - name: cloud_run.max_instances
    description: Maximum instances to scale to
    type: int
    default: "10"

  - name: cloud_run.cpu_throttling
    description: Throttle CPU when not processing requests
    type: bool
    default: "true"

  - name: cloud_run.memory
    description: Memory per instance (e.g., 512Mi, 1Gi)
    type: string
    default: "512Mi"

  - name: cloud_run.cpu
    description: CPUs per instance
    type: string
    default: "1"

  - name: cloud_run.concurrency
    description: Max concurrent requests per instance
    type: int
    default: "80"

  - name: cloud_run.timeout_seconds
    description: Request timeout in seconds
    type: int
    default: "300"

steps:
  - name: build binary
    execution_mode: service_dir
    timeout: 300
    tags:
      - build

  - name: build docker image
    execution_mode: service_dir
    timeout: 300
    tags:
      - build

  - name: publish to registry
    execution_mode: root
    timeout: 120
    tags:
      - push

  - name: deploy to cloud run
    execution_mode: root
    timeout: 180
    default_retries: 2
    tags:
      - deploy
