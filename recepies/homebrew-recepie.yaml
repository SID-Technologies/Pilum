name: homebrew
description: Build and release to Homebrew tap
provider: homebrew

required_fields:
  - name: name
    description: Binary name and Homebrew formula name
    type: string

  - name: description
    description: Short description for the Homebrew formula
    type: string

  - name: license
    description: SPDX license identifier (e.g., MIT, Apache-2.0, BSL-1.1)
    type: string

  - name: homebrew.project_url
    description: Full repository URL where releases are hosted (e.g., https://github.com/org/project)
    type: string

  - name: homebrew.tap_url
    description: Full repository URL for the Homebrew tap (e.g., https://github.com/org/Homebrew-tap)
    type: string

  - name: homebrew.token_env
    description: Environment variable name containing the auth token (e.g., GH_TOKEN, HOMEBREW_TAP_TOKEN)
    type: string

steps:
  # Step 1: Build binaries for all platforms (darwin/linux, amd64/arm64)
  - name: build binaries
    execution_mode: root
    timeout: 300
    tags:
      - build

  # Step 2: Create tar.gz archives for each binary
  - name: create archives
    execution_mode: root
    timeout: 60
    tags:
      - build

  # Step 3: Generate SHA256 checksums
  - name: generate checksums
    execution_mode: root
    timeout: 30
    tags:
      - build

  # Step 4: Update Homebrew formula with new version and checksums
  - name: update formula
    execution_mode: root
    timeout: 30
    tags:
      - deploy

  # Step 5: Push updated formula to Homebrew tap repository
  - name: push to tap
    execution_mode: root
    timeout: 60
    tags:
      - deploy
