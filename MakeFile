##@ Core
.PHONY: help
help:  ## Display this help message.
	@echo "Usage:"
	@echo "  make [target]"
	@awk 'BEGIN {FS = ":.*?## "} \
		/^[a-zA-Z0-9_-]+:.*?## / { \
			printf "\033[36m  %-45s\033[0m %s\n", $$1, $$2 \
		} \
		/^##@/ { \
			printf "\n\033[1m%s\033[0m\n", substr($$0, 5) \
		}' $(MAKEFILE_LIST)

.PHONY: build
build: ## Build the binary to dist/
	@mkdir -p dist
	@go build -o dist/pilum .

.PHONY: clean
clean: ## Remove build artifacts
	@rm -rf dist/

.PHONY: install-tools
install-tools: ## Installs the tools as the git pre-commit hook for this repo as well a dependency tools.
	@which pre-commit > /dev/null || echo "pre-commit not installed, see https://pre-commit.com/#install"
	@pre-commit install --install-hooks

.PHONY: lint
lint: ## Runs linters via pre-commit.
	@pre-commit run -v --all-files

.PHONY: test
test: ## Run E2E tests
	@./test/e2e/run_tests.sh

.PHONY: coverage
coverage: ## Run all tests and show combined coverage
	@go test ./... -coverprofile=coverage-unit.out > /dev/null 2>&1
	@./test/e2e/run_tests.sh > /dev/null 2>&1
	@gocovmerge coverage-unit.out coverage-e2e.out > coverage-combined.out 2>/dev/null || \
		(go install github.com/wadey/gocovmerge@latest && gocovmerge coverage-unit.out coverage-e2e.out > coverage-combined.out)
	@go tool cover -func coverage-combined.out | tail -1
